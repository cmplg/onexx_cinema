<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPL & Playlist Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #050505; --card: #0d0d0d; --border: #222; --blue: #58a6ff; --green: #2ea043; --orange: #d29922; --red: #f85149; }
        body { background: var(--bg); color: #ccc; font-family: 'Inter', sans-serif; margin: 0; }
        
        /* Navbar */
        .navbar { background: #000; border-bottom: 2px solid var(--border); padding: 10px 30px; position: sticky; top: 0; z-index: 1000; height: 80px; }
        .nav-center { position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 30px; }
        .nav-link-sw { color: #555; text-decoration: none; font-weight: 800; font-size: 0.8rem; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .nav-link-sw.active { color: var(--blue); border-bottom: 2px solid var(--blue); padding-bottom: 5px; }
        #clock { font-family: 'JetBrains Mono'; font-size: 2.2rem; color: #fff; font-weight: 800; }

        /* Main Content */
        .content-wrapper { padding: 30px; }
        
        /* Tab Navigation */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { background: #111; border: 1px solid var(--border); color: #888; padding: 10px 20px; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .tab-btn.active { background: var(--blue); color: #000; border-color: var(--blue); }
        .tab-btn:hover { color: #fff; border-color: #444; }

        /* Section Header */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .section-title { font-family: 'Orbitron'; font-size: 1.4rem; color: #fff; font-weight: 800; }
        .section-controls { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Buttons */
        .btn-action { background: #222; border: 1px solid #444; color: #fff; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-action:hover { background: #333; border-color: #555; }
        .btn-primary-sw { background: var(--blue); border-color: var(--blue); color: #000; }
        .btn-primary-sw:hover { background: #6fb5ff; }
        .btn-danger-sw { background: var(--red); border-color: var(--red); color: #fff; }
        .btn-danger-sw:hover { background: #ff7b72; }
        .btn-success-sw { background: var(--green); border-color: var(--green); color: #fff; }
        .btn-success-sw:hover { background: #3fb950; }

        /* Cards & Containers */
        .cpl-card, .playlist-card { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 15px; transition: 0.3s; }
        .cpl-card:hover, .playlist-card:hover { border-color: var(--blue); box-shadow: 0 0 15px rgba(88, 166, 255, 0.1); }
        
        .card-header-cpl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title-cpl { font-size: 1.1rem; font-weight: 700; color: #fff; }
        .card-meta { display: flex; gap: 20px; margin: 10px 0; flex-wrap: wrap; }
        .meta-item { display: flex; flex-direction: column; gap: 3px; }
        .meta-label { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 600; }
        .meta-value { font-size: 0.9rem; color: #eee; font-weight: 500; font-family: 'JetBrains Mono'; }

        /* Tables */
        .mgmt-table { width: 100%; color: #eee; border-collapse: separate; border-spacing: 0 4px; margin-top: 15px; }
        .mgmt-table th { background: #000; color: #666; font-size: 0.7rem; text-transform: uppercase; padding: 12px 15px; border-bottom: 1px solid var(--border); font-weight: 700; letter-spacing: 1px; }
        .mgmt-table td { padding: 12px 15px; background: #111; border-top: 1px solid var(--border); font-size: 0.9rem; }
        .mgmt-table tr:hover td { background: #1a1a1a; }

        /* Badges */
        .badge-status { font-size: 0.65rem; font-weight: 700; padding: 4px 10px; border-radius: 3px; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .badge-cpl { background: rgba(88, 166, 255, 0.15); color: var(--blue); border: 1px solid rgba(88, 166, 255, 0.3); }
        .badge-spl { background: rgba(46, 160, 67, 0.15); color: var(--green); border: 1px solid rgba(46, 160, 67, 0.3); }
        .badge-active { background: rgba(46, 160, 67, 0.15); color: var(--green); }
        .badge-inactive { background: rgba(34, 34, 34, 0.8); color: #888; }
        .badge-kdm { background: rgba(210, 153, 34, 0.15); color: var(--orange); border: 1px solid rgba(210, 153, 34, 0.3); }

        /* Tree Structure */
        .tree-container { margin: 15px 0; background: #0a0a0a; border: 1px solid #222; border-radius: 4px; }
        .tree-item { padding: 12px 15px; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .tree-item:hover { background: #151515; }
        .tree-item.selected { background: rgba(88, 166, 255, 0.1); border-left: 3px solid var(--blue); }
        .tree-toggle { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; color: #666; }
        .tree-content { display: flex; gap: 10px; align-items: center; flex: 1; }
        .tree-icon { width: 20px; text-align: center; }
        .tree-text { flex: 1; }

        /* Search & Filter */
        .search-box { background: #111; border: 1px solid var(--border); color: #fff; padding: 10px 15px; border-radius: 4px; width: 100%; max-width: 350px; }
        .search-box::placeholder { color: #666; }

        /* Info Panel */
        .info-panel { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin: 20px 0; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
        .info-label { color: #888; font-size: 0.9rem; font-weight: 600; }
        .info-value { color: #fff; font-size: 0.9rem; font-family: 'JetBrains Mono'; }

        /* Progress Bar */
        .progress-custom { background: #000; height: 6px; border-radius: 3px; border: 1px solid #222; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--blue); transition: width 0.3s; }

        /* Empty State */
        .empty-state { text-align: center; padding: 50px 20px; color: #666; }
        .empty-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.5; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-center { position: relative; left: 0; transform: none; margin-top: 10px; gap: 15px; }
            .navbar { height: auto; flex-direction: column; }
            .content-wrapper { padding: 15px; }
            .card-meta { flex-direction: column; gap: 10px; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 15px; }
        }
    </style>
</head>
<body>

<nav class="navbar navbar-dark">
    <div class="container-fluid">
        <span class="navbar-brand" style="font-family: 'Orbitron'; font-weight: 800;">ONEXX NOC - CPL/PLAYLIST MGMT</span>
        <div class="nav-center">
            <div id="btn-overview" class="nav-link-sw" onclick="goBack()">← Back to NOC</div>
            <div id="btn-cpl-mgmt" class="nav-link-sw active" onclick="showTab('cpl')">CPL Management</div>
            <div id="btn-playlist-mgmt" class="nav-link-sw" onclick="showTab('playlist')">Playlist Management</div>
            <div id="btn-mapping" class="nav-link-sw" onclick="showTab('mapping')">CPL-Playlist Mapping</div>
        </div>
        <div id="clock">00:00:00</div>
    </div>
</nav>

<div class="content-wrapper">

    <!-- TAB: CPL MANAGEMENT -->
    <div id="tab-cpl" class="tab-content">
        <div class="section-header">
            <div class="section-title">CPL LIBRARY</div>
            <div class="section-controls">
                <input type="text" id="search-cpl" class="search-box" placeholder="Search CPL...">
                <button class="btn-action btn-primary-sw" onclick="showImportCPLModal()"><i class="fa fa-plus"></i> Import CPL</button>
                <button class="btn-action" onclick="refreshCPLList()"><i class="fa fa-sync"></i> Refresh</button>
            </div>
        </div>

        <div id="cpl-list-container">
            <div class="empty-state">
                <div class="empty-icon"><i class="fa fa-hourglass-half"></i></div>
                <div>Loading CPL Library...</div>
            </div>
        </div>
    </div>

    <!-- TAB: PLAYLIST MANAGEMENT -->
    <div id="tab-playlist" class="tab-content d-none">
        <div class="section-header">
            <div class="section-title">SHOW PLAYLIST (SPL) MANAGEMENT</div>
            <div class="section-controls">
                <select id="studio-select" class="form-select" style="max-width: 150px; background: #111; border: 1px solid var(--border); color: #fff;">
                    <option value="1">TH 1</option>
                    <option value="2">TH 2</option>
                    <option value="3">TH 3</option>
                </select>
                <input type="text" id="search-playlist" class="search-box" placeholder="Search Playlist...">
                <button class="btn-action btn-primary-sw" onclick="showCreatePlaylistModal()"><i class="fa fa-plus"></i> Create Playlist</button>
                <button class="btn-action" onclick="refreshPlaylistList()"><i class="fa fa-sync"></i> Refresh</button>
            </div>
        </div>

        <div id="playlist-list-container">
            <div class="empty-state">
                <div class="empty-icon"><i class="fa fa-hourglass-half"></i></div>
                <div>Loading Playlists...</div>
            </div>
        </div>
    </div>

    <!-- TAB: CPL-PLAYLIST MAPPING -->
    <div id="tab-mapping" class="tab-content d-none">
        <div class="section-header">
            <div class="section-title">CPL TO PLAYLIST MAPPING</div>
            <div class="section-controls">
                <button class="btn-action btn-primary-sw" onclick="showMappingModal()"><i class="fa fa-link"></i> Create Mapping</button>
                <button class="btn-action" onclick="refreshMappings()"><i class="fa fa-sync"></i> Refresh</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="filterMappings('all')">All Mappings</button>
            <button class="tab-btn" onclick="filterMappings('active')">Active</button>
            <button class="tab-btn" onclick="filterMappings('with-kdm')">With KDM</button>
            <button class="tab-btn" onclick="filterMappings('expiring')">Expiring Soon</button>
        </div>

        <div id="mapping-list-container">
            <div class="empty-state">
                <div class="empty-icon"><i class="fa fa-hourglass-half"></i></div>
                <div>Loading Mappings...</div>
            </div>
        </div>
    </div>

</div>

<!-- MODAL: IMPORT CPL -->
<div class="modal fade" id="importCPLModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #111; border: 1px solid var(--border); color: #fff;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border);">
                <h5 class="modal-title"><i class="fa fa-upload"></i> Import CPL</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">CPL File</label>
                    <input type="file" id="cpl-file-input" class="form-control" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Target Directory</label>
                    <select id="target-dir" class="form-select" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                        <option>/storage/cpls</option>
                        <option>/mnt/nas/cpls</option>
                    </select>
                </div>
                <div id="import-progress" style="display: none; margin: 15px 0;">
                    <div style="color: #888; font-size: 0.9rem; margin-bottom: 8px;">Uploading...</div>
                    <div class="progress" style="background: #000; height: 8px;">
                        <div id="import-progress-bar" class="progress-bar" style="background: var(--blue); width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border);">
                <button type="button" class="btn-action" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-action btn-primary-sw" onclick="importCPL()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: CREATE PLAYLIST -->
<div class="modal fade" id="createPlaylistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #111; border: 1px solid var(--border); color: #fff;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border);">
                <h5 class="modal-title"><i class="fa fa-list"></i> Create Playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Playlist Name</label>
                    <input type="text" id="playlist-name" class="form-control" style="background: #0a0a0a; border: 1px solid #222; color: #fff;" placeholder="e.g., Weekday Schedule">
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Description</label>
                    <textarea id="playlist-desc" class="form-control" rows="3" style="background: #0a0a0a; border: 1px solid #222; color: #fff;" placeholder="Optional description"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Theater</label>
                    <select id="playlist-theater" class="form-select" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                        <option value="1">TH 1</option>
                        <option value="2">TH 2</option>
                        <option value="3">TH 3</option>
                    </select>
                </div>
                <div class="info-panel" style="background: #0a0a0a; border: 1px solid #222; margin: 15px 0;">
                    <div class="info-row">
                        <span class="info-label">Auto Start</span>
                        <input type="checkbox" id="playlist-autostart">
                    </div>
                    <div class="info-row">
                        <span class="info-label">Loop Playlist</span>
                        <input type="checkbox" id="playlist-loop" checked>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border);">
                <button type="button" class="btn-action" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-action btn-primary-sw" onclick="createPlaylist()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: CPL-PLAYLIST MAPPING -->
<div class="modal fade" id="mappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #111; border: 1px solid var(--border); color: #fff;">
            <div class="modal-header" style="border-bottom: 1px solid var(--border);">
                <h5 class="modal-title"><i class="fa fa-link"></i> Create CPL-Playlist Mapping</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Select CPL</label>
                    <select id="mapping-cpl" class="form-select" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                        <option value="">Loading CPLs...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Select Playlist</label>
                    <select id="mapping-playlist" class="form-select" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                        <option value="">Loading Playlists...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">Start Position (seconds)</label>
                    <input type="number" id="mapping-start" class="form-control" style="background: #0a0a0a; border: 1px solid #222; color: #fff;" value="0" min="0">
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: #fff;">KDM File</label>
                    <input type="file" id="mapping-kdm" class="form-control" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                </div>
                <div class="info-panel" style="background: #0a0a0a; border: 1px solid #222; margin: 15px 0;">
                    <div class="info-row">
                        <span class="info-label">KDM Expires</span>
                        <input type="datetime-local" id="mapping-kdm-expire" style="background: #0a0a0a; border: 1px solid #222; color: #fff;">
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border);">
                <button type="button" class="btn-action" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-action btn-primary-sw" onclick="createMapping()">Create Mapping</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentTab = 'cpl';
    let currentFilterMapping = 'all';

    // Utilities
    function format(s) {
        if (!s || s <= 0) return "00:00:00";
        let h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = Math.floor(s % 60);
        return [h, m, sec].map(v => v < 10 ? "0" + v : v).join(":");
    }

    function goBack() { window.location.href = '/'; }

    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
        document.getElementById('tab-' + tab).classList.remove('d-none');
        document.querySelectorAll('.nav-link-sw').forEach(el => el.classList.remove('active'));
        document.getElementById('btn-' + tab + '-mgmt').classList.add('active');
        currentTab = tab;

        if (tab === 'cpl') refreshCPLList();
        else if (tab === 'playlist') refreshPlaylistList();
        else if (tab === 'mapping') refreshMappings();
    }

    // CPL MANAGEMENT
    async function refreshCPLList() {
        const container = document.getElementById('cpl-list-container');
        container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-hourglass-half"></i></div><div>Loading...</div></div>';
        
        try {
            const res = await fetch('/api/content_library');
            const cpls = await res.json();
            
            if (cpls.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-folder-open"></i></div><div>No CPLs found</div></div>';
                return;
            }

            let html = '';
            cpls.forEach(cpl => {
                html += `
                <div class="cpl-card">
                    <div class="card-header-cpl">
                        <div class="card-title-cpl">
                            <i class="fa fa-film" style="color: var(--blue); margin-right: 10px;"></i>${cpl.title}
                            <span class="badge-status badge-cpl" style="margin-left: 10px;">CPL</span>
                        </div>
                        <div>
                            <button class="btn-action" onclick="editCPL('${cpl.uuid}')" title="Edit"><i class="fa fa-edit"></i></button>
                            <button class="btn-action btn-danger-sw" onclick="deleteCPL('${cpl.uuid}')" title="Delete"><i class="fa fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="card-meta">
                        <div class="meta-item">
                            <span class="meta-label">UUID</span>
                            <span class="meta-value">${cpl.uuid.substring(0, 20)}...</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Duration</span>
                            <span class="meta-value">${cpl.duration || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Size</span>
                            <span class="meta-value">${cpl.size || 'N/A'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">KDM Status</span>
                            <span class="meta-value">${cpl.kdm ? '<span style="color: var(--green);">✓ Valid</span>' : '<span style="color: #888;">Not Required</span>'}</span>
                        </div>
                    </div>
                    <div class="progress-custom">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                    <small style="color: #666;">Last Modified: ${new Date().toLocaleString('id-ID')}</small>
                </div>`;
            });

            container.innerHTML = html;
        } catch (err) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-exclamation-circle"></i></div><div>Error loading CPLs</div></div>';
        }
    }

    function showImportCPLModal() {
        new bootstrap.Modal(document.getElementById('importCPLModal')).show();
    }

    async function importCPL() {
        const fileInput = document.getElementById('cpl-file-input');
        const targetDir = document.getElementById('target-dir').value;
        const progressDiv = document.getElementById('import-progress');

        if (!fileInput.files.length) {
            alert('Please select a CPL file');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('target_dir', targetDir);

        progressDiv.style.display = 'block';

        try {
            const res = await fetch('/api/import_cpl', { method: 'POST', body: formData });
            const data = await res.json();
            progressDiv.style.display = 'none';
            alert(data.message || 'CPL imported successfully');
            bootstrap.Modal.getInstance(document.getElementById('importCPLModal')).hide();
            refreshCPLList();
        } catch (err) {
            progressDiv.style.display = 'none';
            alert('Error importing CPL: ' + err.message);
        }
    }

    async function editCPL(uuid) {
        alert('Edit functionality for CPL: ' + uuid);
    }

    async function deleteCPL(uuid) {
        if (!confirm('Are you sure you want to delete this CPL?')) return;
        // Implementation
    }

    // PLAYLIST MANAGEMENT
    async function refreshPlaylistList() {
        const container = document.getElementById('playlist-list-container');
        const studioId = document.getElementById('studio-select').value;
        container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-hourglass-half"></i></div><div>Loading...</div></div>';

        try {
            const res = await fetch(`/api/playlists/${studioId}`);
            const playlists = await res.json();

            if (playlists.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-list"></i></div><div>No Playlists found for TH ' + studioId + '</div></div>';
                return;
            }

            let html = '<table class="mgmt-table"><thead><tr><th>Playlist</th><th>Items</th><th>Duration</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            playlists.forEach(pl => {
                html += `<tr>
                    <td><i class="fa fa-list" style="color: var(--green); margin-right: 8px;"></i><strong>${pl.title}</strong></td>
                    <td>${pl.items || 0}</td>
                    <td><code>${pl.duration || '00:00:00'}</code></td>
                    <td><span class="badge-status badge-active">ACTIVE</span></td>
                    <td>
                        <button class="btn-action" onclick="editPlaylist('${pl.uuid}')" title="Edit"><i class="fa fa-edit"></i></button>
                        <button class="btn-action" onclick="viewPlaylistDetails('${pl.uuid}')" title="View Details"><i class="fa fa-info-circle"></i></button>
                        <button class="btn-action btn-danger-sw" onclick="deletePlaylist('${pl.uuid}')" title="Delete"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            container.innerHTML = html + '</tbody></table>';
        } catch (err) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-exclamation-circle"></i></div><div>Error loading Playlists</div></div>';
        }
    }

    function showCreatePlaylistModal() {
        new bootstrap.Modal(document.getElementById('createPlaylistModal')).show();
    }

    async function createPlaylist() {
        const name = document.getElementById('playlist-name').value;
        const desc = document.getElementById('playlist-desc').value;
        const theater = document.getElementById('playlist-theater').value;
        const autostart = document.getElementById('playlist-autostart').checked;
        const loop = document.getElementById('playlist-loop').checked;

        if (!name) {
            alert('Please enter a playlist name');
            return;
        }

        try {
            const res = await fetch('/api/create_playlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, desc, theater, autostart, loop })
            });
            const data = await res.json();
            alert(data.message || 'Playlist created successfully');
            bootstrap.Modal.getInstance(document.getElementById('createPlaylistModal')).hide();
            refreshPlaylistList();
        } catch (err) {
            alert('Error creating playlist: ' + err.message);
        }
    }

    async function editPlaylist(uuid) { alert('Edit playlist: ' + uuid); }
    async function viewPlaylistDetails(uuid) { alert('View details: ' + uuid); }
    async function deletePlaylist(uuid) {
        if (confirm('Delete this playlist?')) alert('Deleting: ' + uuid);
    }

    // CPL-PLAYLIST MAPPING
    async function refreshMappings() {
        const container = document.getElementById('mapping-list-container');
        container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-hourglass-half"></i></div><div>Loading...</div></div>';

        try {
            const res = await fetch('/api/cpl_playlist_mappings');
            const mappings = await res.json();

            if (mappings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-link"></i></div><div>No Mappings found</div></div>';
                return;
            }

            let html = '<table class="mgmt-table"><thead><tr><th>CPL</th><th>Playlist</th><th>Theater</th><th>KDM Status</th><th>Expires</th><th>Actions</th></tr></thead><tbody>';
            
            mappings.forEach(m => {
                const kdmBadge = m.kdm_status === 'valid' ? '<span class="badge-status badge-kdm">KDM Valid</span>' : '<span class="badge-status badge-inactive">No KDM</span>';
                html += `<tr>
                    <td>${m.cpl_title}</td>
                    <td>${m.playlist_title}</td>
                    <td>TH ${m.theater_id}</td>
                    <td>${kdmBadge}</td>
                    <td><code>${m.kdm_expires || 'N/A'}</code></td>
                    <td>
                        <button class="btn-action" onclick="editMapping('${m.id}')" title="Edit"><i class="fa fa-edit"></i></button>
                        <button class="btn-action btn-danger-sw" onclick="deleteMapping('${m.id}')" title="Delete"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>`;
            });

            container.innerHTML = html + '</tbody></table>';
        } catch (err) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon"><i class="fa fa-exclamation-circle"></i></div><div>Error loading Mappings</div></div>';
        }
    }

    function filterMappings(filter) {
        currentFilterMapping = filter;
        document.querySelectorAll('#mapping-list-container .tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        // Implementation of filtering logic
    }

    function showMappingModal() {
        new bootstrap.Modal(document.getElementById('mappingModal')).show();
    }

    async function createMapping() {
        alert('Create mapping functionality');
    }

    async function editMapping(id) { alert('Edit mapping: ' + id); }
    async function deleteMapping(id) {
        if (confirm('Delete this mapping?')) alert('Deleting mapping: ' + id);
    }

    // Clock Update
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID', { hour12: false });
    }, 1000);

    // Initialize
    refreshCPLList();
</script>
</body>
</html>
